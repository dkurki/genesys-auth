<!DOCTYPE html>
<html>
<head>
    <title>Genesys WebRTC Controller</title>
    <script src="https://sdk-cdn.mypurecloud.com/webrtc-sdk/v3/genesys-cloud-webrtc-sdk.bundle.min.js"></script>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; background: #f4f6f9;">
    <div style="max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h3 style="margin-top:0;">Genesys Status: <span id="status" style="color: orange;">Initializing...</span></h3>
        <p id="details" style="font-size: 14px; color: #666;">Extracting authentication token...</p>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const detailsEl = document.getElementById('details');
        
        // 1. Extract Token from Hash
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get('access_token');

        if (token) {
            // 2. Initialize SDK
            // Note: 'usw2.pure.cloud' is Oregon. Ensure this matches your Genesys Org region!
            const sdk = new window.GenesysCloudWebrtcSdk({
                accessToken: token,
                environment: 'usw2.pure.cloud' 
            });

            sdk.initialize().then(() => {
                statusEl.innerText = 'READY';
                statusEl.style.color = 'green';
                detailsEl.innerText = 'Connected. You can return to Salesforce.';

                // 3. Notify Salesforce LWC that we are ready
                if (window.opener) {
                    window.opener.postMessage({ 
                        type: 'GENESYS_AUTH_SUCCESS', 
                        token: token 
                    }, window.location.origin); 
                }
            }).catch(err => {
                statusEl.innerText = 'FAILED';
                statusEl.style.color = 'red';
                detailsEl.innerText = 'SDK Error: ' + err.message;
            });

            // 4. Command Listener (Inbound from Salesforce)
            window.addEventListener('message', (event) => {
                // Security: In production, check event.origin here
                const { type, phoneNumber, sessionId } = event.data;

                if (type === 'COMMAND_MAKE_CALL') {
                    sdk.startVideoCall({ address: phoneNumber }); // address is the correct param for WebRTC SDK
                } else if (type === 'COMMAND_END_CALL') {
                    sdk.endSession(sessionId);
                }
            });
        } else {
            statusEl.innerText = 'NO TOKEN';
            statusEl.style.color = 'red';
            detailsEl.innerText = 'Authentication failed. Please close this window and retry.';
        }
    </script>
</body>
</html>
