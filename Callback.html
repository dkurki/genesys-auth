<!DOCTYPE html>
<html>
<head>
    <title>Genesys WebRTC Controller</title>
    <script src="https://sdk-cdn.mypurecloud.com/webrtc-sdk/v3/genesys-cloud-webrtc-sdk.bundle.min.js"></script>
</head>
<body>
    <h3>Genesys Connection Active</h3>
    <p>Do not close this window. It is handling the audio for Salesforce.</p>

    <script>
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        const token = params.get('access_token');

        if (token) {
            const sdk = new window.GenesysCloudWebrtcSdk({
                accessToken: token,
                environment: 'usw2.pure.cloud'
            });

            sdk.initialize().then(() => {
                console.log('SDK initialized in popup');
                // Tell Salesforce LWC we are ready to take commands
                window.opener.postMessage({ type: 'GENESYS_AUTH_READY' }, '*');
            });

            // Listen for the "COMMAND_MAKE_CALL" from Salesforce
            window.addEventListener('message', (event) => {
                if (event.data.type === 'COMMAND_MAKE_CALL') {
                    console.log('Dialing:', event.data.phoneNumber);
                    sdk.startSession({ phoneNumber: event.data.phoneNumber });
                }
            });
        }
    </script>
</body>
</html>
