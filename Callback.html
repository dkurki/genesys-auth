<!DOCTYPE html>
<html>
<head>
    <title>Genesys Auth Callback</title>
    <script src="https://sdk-cdn.mypurecloud.com/webrtc-sdk/v3/genesys-cloud-webrtc-sdk.bundle.min.js"></script>
</head>
<body>
    <p>Authenticating with Genesys... You can close this window if it doesn't close automatically.</p>
    <script>
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const token = urlParams.get('access_token');

        if (token) {
            // Initialize the SDK right here in the popup
            const sdk = new window.GenesysCloudWebrtcSdk({
                accessToken: token,
                environment: 'usw2.pure.cloud'
            });

            sdk.initialize().then(() => {
                console.log('SDK Ready in Popup');
                // Tell Salesforce we are authenticated and the SDK is ready
                window.opener.postMessage({ type: 'GENESYS_AUTH_READY' }, '*');
            });

            // Listen for commands from the Salesforce LWC
            window.addEventListener('message', (event) => {
                if (event.data.type === 'COMMAND_MAKE_CALL') {
                    console.log('Popup received Dial command for:', event.data.phoneNumber);
                    sdk.startSession({ phoneNumber: event.data.phoneNumber });
                }
            });
        }
    </script>
</body>
</html>
